from dna_common.config import BaseConfig
from dna_common.database.aio import AioSqlAlchemy


def setup_database(app, name='db', config_prefix=None):
    async def on_startup(app):
        config = app.config.dict(config_prefix or f'{name}_')
        app[name] = AioSqlAlchemy(**config)
        # test connection
        await app[name].execute('SELECT 1')

    async def on_cleanup(app):
        await app[name].dispose()

    app.add_listener('startup', on_startup)
    app.add_listener('cleanup', on_cleanup)
