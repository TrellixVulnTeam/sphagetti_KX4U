from collections import namedtuple

from sqlalchemy.sql import text


TableValuedParams = namedtuple('TableValuedParams', ['table_type', 'rows', 'columns'])


def prepare_exec(procedure, *args, **kwargs):
    if args and kwargs:
        raise ValueError('Parameters must be all positional or all keyed')

    if args:
        raise ValueError('Only kwargs supported')

    statements = []
    exec_params = []
    bind_params = {}

    for key, value in kwargs.items():
        if isinstance(value, TableValuedParams):
            values = []
            for row_index, row in enumerate(value.rows):
                row_params = []
                for col_index, col in enumerate(row):
                    param = f'{key}_{row_index}_{col_index}'
                    bind_params[param] = col
                    row_params.append(f':{param}')
                values.append(f'({",".join(row_params)})')
            statements.append(f'DECLARE @{key} AS {value.table_type}')
            columns = f'({",".join(value.columns)})' if value.columns else ''
            statements.append(f'INSERT INTO @{key} {columns} VALUES {",".join(values)}')
            exec_params.append(f'@{key}=@{key}')
        else:
            bind_params[key] = value
            exec_params.append(f'@{key}=:{key}')

    statements.append(f'EXEC {procedure} {",".join(exec_params)}')

    return text('\n'.join(statements)).bindparams(**bind_params)
